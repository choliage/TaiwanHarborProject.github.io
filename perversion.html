1140323 2248 é–‹é ­éŠæˆ²ç¤ºç¯„ç‰ˆ.html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18ä¸–ç´€å°ç£æ¸¯å£çŒœè¬éŠæˆ² (ç¤ºç¯„ç‰ˆ)</title>
    <!-- è¼‰å…¥Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- è¼‰å…¥å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Almendra:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* åŸºæœ¬æ¨£å¼ */
        body {
            font-family: 'Noto Serif TC', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            width: 100%;
            height: 100vh;
            max-height: 100vh;
        }
        
        .map-container {
            width: 75%;
            height: 100%;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .controls-container {
            width: 25%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            justify-content: space-between;
        }
        
        /* è¨ˆæ™‚å™¨è¨­ç½®å€åŸŸ */
        .timer-settings {
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        
        .timer-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 28px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 2px solid #333;
            text-align: center;
            min-width: 150px;
        }
        
        /* æ¸¯å£åç¨±é¡¯ç¤º */
        .port-name-display {
            background-color: #EAEFF8;
            border-radius: 10px;
            padding: 8px 5px;
            text-align: center;
            font-weight: 900;
            font-size: clamp(20px, 4vw, 30px);
            height: 15%;
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* è¼ªæ¬¡å’Œç­‰ç´šé¡¯ç¤º */
        .status-row {
            display: flex;
            gap: 8px;
            height: 8%;
            min-height: 40px;
        }
        
        .round-display, .level-display {
            background-color: #FDEBE7;
            border-radius: 10px;
            padding: 5px;
            text-align: center;
            flex: 1;
            font-family: 'Almendra', serif !important;
            font-weight: 700;
            font-size: clamp(18px, 3vw, 22px);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* æŒ‰éˆ•ç¶²æ ¼ */
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            flex-grow: 1;
            height: 75%;
        }
        
        button {
            border: none;
            border-radius: 8px;
            padding: 5px;
            font-size: clamp(14px, 2vw, 18px);
            font-family: 'Noto Serif TC', sans-serif !important;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            white-space: nowrap;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .next-round-btn {
            grid-column: span 2;
            font-size: clamp(14px, 2vw, 16px);
        }
        
        /* çµ„åˆ¥æŒ‰éˆ•é¡è‰² */
        .group1-btn { background-color: #DA6B6B; font-weight: bold; }
        .group2-btn { background-color: #DABF6B; font-weight: bold; }
        .group3-btn { background-color: #9CB68A; font-weight: bold; }
        .group5-btn { background-color: #7D98B1; font-weight: bold; }
        .draw-port-btn { background-color: #780116; color: white; font-weight: 900; }
        .confirm-pos-btn { background-color: #CDE4BE; font-weight: 900; }
        .show-answer-btn { background-color: #E9F9FF; font-weight: 900; }
        .show-result-btn { background-color: #E2CC8A; font-weight: 900; }
        .next-round-btn { background-color: #CFD6E0; font-weight: 900; }
        
        /* åœ°åœ–æ¨™è¨˜æ¨£å¼ */
        .marker-group1 { background-color: #DA6B6B; border-radius: 50%; border: 3px solid white; }
        .marker-group2 { background-color: #DABF6B; border-radius: 50%; border: 3px solid white; }
        .marker-group3 { background-color: #9CB68A; border-radius: 50%; border: 3px solid white; }
        .marker-group5 { background-color: #7D98B1; border-radius: 50%; border: 3px solid white; }
        .answer-marker { background-color: #9b59b6; border-radius: 50%; border: 3px solid white; }
        
        /* è‡ªå®šç¾©å½ˆå‡ºçª—å£æ¨£å¼ */
        .custom-popup .leaflet-popup-content-wrapper {
            background-color: white;
            border: 2px solid black;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 10px;
            min-width: 150px;
        }
        
        .custom-popup .leaflet-popup-tip-container {
            display: none; /* éš±è—æŒ‡å‘æ¨™è¨˜çš„å°ä¸‰è§’ */
        }
        
        /* éš±è—åœ°åœ–ç‰ˆæ¬Šä¿¡æ¯ */
        .leaflet-control-attribution { display: none !important; }
        
        /* è¨ˆæ™‚å™¨æ•ˆæœ */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .timer-critical {
            background-color: #FF5252 !important;
            animation: pulse 1s infinite;
        }
        
        .timer-warning {
            background-color: #FFEB3B !important;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-aspect-ratio: 4/3) {
            .container { flex-direction: column; }
            .map-container { width: 100%; height: 70%; }
            .controls-container { width: 100%; height: 30%; flex-direction: row; flex-wrap: wrap; }
        }
        
        /* æ¨¡æ…‹è¦–çª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-content {
            background-color: white;
            width: 40%;
            min-width: 280px;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            padding: clamp(10px, 2vw, 20px);
            position: relative;
            margin: 0 auto;
            font-size: clamp(12px, 2vw, 16px);
        }
        
        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 2010;
        }
        
        .modal-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-nav-btn.prev {
            left: -20px;
        }
        
        .modal-nav-btn.next {
            right: -20px;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            background-color: #f1f1f1;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
        }
        
        .result-header, .leaderboard-section {
            font-family: 'Noto Serif TC', sans-serif !important;
        }

        /* ç›®å‰æ´»å‹•çµ„åˆ¥é¡¯ç¤º */
        .active-group-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 2px solid #333;
        }
        
        /* ç¤ºç¯„ç‰ˆæ¨™è¨˜ */
        .demo-label {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #FFF2CC;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* å®Œæˆç¤ºç¯„æ¨¡æ…‹çª—å£ */
        .demo-complete-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .demo-complete-content {
            background-color: white;
            width: 50%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .demo-complete-title {
            width: 100%;
            color: #2e75b6;
            font-family: 'Noto Serif TC', sans-serif;
            font-weight: 900;
            font-size: 32px;
            text-align: center;
            padding: 30px 0;
            background-color: #e3f1fd;
            position: relative;
        }
        
        .demo-complete-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 6px;
            background-color: #3982c2;
        }
        
        .start-game-btn {
            background-color: #fff4d5;
            color: #000;
            font-family: 'Noto Serif TC', sans-serif;
            font-weight: 900;
            font-size: 22px;
            padding: 15px 40px;
            border-radius: 8px;
            cursor: pointer;
            margin: 40px 0;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <div id="map"></div>
            
            <!-- è¨ˆæ™‚å™¨é¡¯ç¤º -->
            <div id="timer-display" class="timer-display">
                <div>å‰©é¤˜æ™‚é–“</div>
                <div id="countdown-timer">30.00</div>
                <div>ç§’</div>
            </div>
            
            <!-- ç›®å‰æ´»å‹•çµ„åˆ¥é¡¯ç¤º -->
            <div id="active-group-display" class="active-group-display"></div>
            
            <!-- ç¤ºç¯„ç‰ˆæ¨™è¨˜ -->
            <div class="demo-label">éŠæˆ²ç¤ºç¯„</div>
        </div>
        
        <div class="controls-container">
            <!-- è¨ˆæ™‚å™¨è¨­ç½® -->
            <div class="timer-settings">
                <div style="margin-bottom: 8px; font-weight: bold;">è¨ˆæ™‚å™¨è¨­ç½®</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="timer-seconds">æ¯çµ„ç­”é¡Œæ™‚é–“ (ç§’):</label>
                    <input type="number" id="timer-seconds" min="1" max="120" value="30" style="width: 60px;">
                    <button id="save-timer" style="padding: 5px 10px; background-color: #4CAF50; color: white;">è¨­å®š</button>
                </div>
            </div>
            
            <!-- æ¸¯å£åç¨±é¡¯ç¤º -->
            <div class="port-name-display" id="port-name">è«‹æŠ½å–æ¸¯å£...</div>
            
            <!-- è¼ªæ¬¡å’Œç­‰ç´šé¡¯ç¤º -->
            <div class="status-row">
                <div class="round-display" id="round-display">1/3</div>
                <div class="level-display" id="level-display">Lv.<span id="port-level-value">-</span></div>
            </div>
            
            <!-- æŒ‰éˆ•ç¶²æ ¼ -->
            <div class="button-grid">
                <button class="group1-btn" data-group="1">ç¬¬ä¸€çµ„</button>
                <button class="draw-port-btn" id="random-port-btn">æŠ½æ¸¯å£</button>
                
                <button class="group2-btn" data-group="2">ç¬¬äºŒçµ„</button>
                <button class="confirm-pos-btn" id="confirm-guess" disabled>ç¢ºèªä½ç½®</button>
                
                <button class="group3-btn" data-group="3">ç¬¬ä¸‰çµ„</button>
                <button class="show-answer-btn" id="show-answer-btn" disabled>å…¬å¸ƒç­”æ¡ˆ</button>
                
                <button class="group5-btn" data-group="5">ç¬¬äº”çµ„</button>
                <button class="show-result-btn" id="show-result-btn" disabled>å±•ç¤ºæœ¬è¼ª</button>
                
                <button class="next-round-btn" id="next-port-btn" disabled>ä¸‹ä¸€è¼ª(ä¸‹ä¸€å€‹æ¸¯å£)</button>
            </div>
        </div>
    </div>

    <!-- çµæœæ¨¡æ…‹è¦–çª— -->
    <div class="modal-overlay" id="results-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">&times;</button>
            <button class="modal-nav-btn prev" id="prev-result-btn">&#9664;</button>
            <button class="modal-nav-btn next" id="next-result-btn">&#9654;</button>
            <div class="result-header" style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #eaeaea; padding-bottom: 10px;">
                <h2 id="round-title" style="font-size: clamp(16px, 3vw, 20px); margin-bottom: 5px;"></h2>
                <p id="port-result-name" style="font-size: clamp(14px, 2.5vw, 18px); margin-top: 5px;"></p>
            </div>
            <div class="winner-section" style="background-color: #fcf8e3; border-left: 5px solid #f0ad4e; padding: 10px; margin-bottom: 15px; display: flex; align-items: center; border-radius: 4px;">
                <div style="font-size: clamp(18px, 3vw, 24px); color: #f0ad4e; display: inline-block; margin-right: 10px;">ğŸ†</div>
                <div style="flex: 1;">
                    <h3 id="winner-title" style="font-size: clamp(14px, 2.5vw, 18px); margin: 0 0 5px 0;">æ­å–œç²å‹çµ„åˆ¥</h3>
                    <p id="winner-info" style="font-size: clamp(12px, 2vw, 16px); margin: 0;"></p>
                </div>
            </div>
            <div class="leaderboard-section" style="margin-top: 15px;">
                <h3 style="font-size: clamp(14px, 2.5vw, 18px); margin: 0 0 8px 0;">ç›®å‰çš„æ’è¡Œæ¦œ</h3>
                <table class="leaderboard-table" style="width: 100%; border-collapse: collapse; font-size: clamp(11px, 1.8vw, 14px);">
                    <thead>
                        <tr>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">æ’å</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">å°çµ„</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">ç¸½ç©åˆ†</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">æœ¬è¼ªå¾—åˆ†</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">æœ¬è¼ªè·é›¢</th>
                        </tr>
                    </thead>
                    <tbody id="modal-leaderboard">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- æœ€çµ‚çµæœæ¨¡æ…‹è¦–çª— -->
    <div class="modal-overlay" id="final-results-modal">
        <div class="modal-content">
            <button class="modal-close" id="final-modal-close">&times;</button>
            <button class="modal-nav-btn prev" id="prev-final-result-btn">&#9664;</button>
            <div class="result-header" style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #eaeaea; padding-bottom: 10px;">
                <h2 style="font-size: clamp(16px, 3vw, 20px); margin-bottom: 5px;">éŠæˆ²çµæŸ - æœ€çµ‚çµæœ</h2>
            </div>
            <div class="winner-section" style="background-color: #fcf8e3; border-left: 5px solid #f0ad4e; padding: 10px; margin-bottom: 15px; display: flex; align-items: center; border-radius: 4px;">
                <div style="font-size: clamp(18px, 3vw, 24px); color: #f0ad4e; display: inline-block; margin-right: 10px;">ğŸ†</div>
                <div style="flex: 1;">
                    <h3 id="final-winner-title" style="font-size: clamp(14px, 2.5vw, 18px); margin: 0 0 5px 0;">æ­å–œæœ€çµ‚å† è»</h3>
                    <p id="final-winner-info" style="font-size: clamp(12px, 2vw, 16px); margin: 0;"></p>
                </div>
            </div>
            <div class="leaderboard-section" style="margin-top: 15px;">
                <h3 style="font-size: clamp(14px, 2.5vw, 18px); margin: 0 0 8px 0;">æœ€çµ‚æ’è¡Œæ¦œ</h3>
                <table class="leaderboard-table" style="width: 100%; border-collapse: collapse; font-size: clamp(11px, 1.8vw, 14px);">
                    <thead>
                        <tr>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">æ’å</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">å°çµ„</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">æœ€çµ‚ç¸½ç©åˆ†</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">ç¬¬ä¸‰è¼ªå¾—åˆ†</th>
                            <th style="background-color: #f2f2f2; padding: 5px 3px; text-align: left;">ç¬¬ä¸‰è¼ªè·é›¢</th>
                        </tr>
                    </thead>
                    <tbody id="final-modal-leaderboard">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- å®Œæˆç¤ºç¯„æ¨¡æ…‹è¦–çª— -->
    <div class="demo-complete-modal" id="demo-complete-modal">
        <div class="demo-complete-content">
            <div class="demo-complete-title">å®Œæˆç¤ºç¯„</div>
            <button class="start-game-btn" id="start-game-btn">é–‹å§‹æ­£å¼éŠæˆ²</button>
        </div>
    </div>

    <script>
        // ç¢ºä¿åªåœ¨é é¢å®Œå…¨è¼‰å…¥å¾ŒåŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–
        let gameInitialized = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            if (gameInitialized) return;
            gameInitialized = true;
            
            console.log('DOMå·²è¼‰å…¥ï¼Œåˆå§‹åŒ–éŠæˆ²...');
            initGame();
        });

        function initGame() {
            console.log('é–‹å§‹åˆå§‹åŒ–éŠæˆ²');
            
            // è¨ˆæ™‚å™¨è®Šæ•¸
            let timerSeconds = 30;
            let currentTimer = null;
            let currentTimerElement = document.getElementById('countdown-timer');
            let timerDisplayElement = document.getElementById('timer-display');
            let activeGroupDisplayElement = document.getElementById('active-group-display');
            let timerSettingsElement = document.querySelector('.timer-settings');
            let timerStartTime = 0;
            let timerEndTime = 0;
            
            // è¨­ç½®è¨ˆæ™‚å™¨
            document.getElementById('save-timer').addEventListener('click', function() {
                const inputValue = parseInt(document.getElementById('timer-seconds').value, 10);
                if (inputValue >= 1 && inputValue <= 120) {
                    timerSeconds = inputValue;
                    alert(`æ¯çµ„ç­”é¡Œæ™‚é–“å·²è¨­ç½®ç‚º ${timerSeconds} ç§’`);
                } else {
                    alert('è«‹è¼¸å…¥1åˆ°120ä¹‹é–“çš„ç§’æ•¸');
                }
            });
            
            // ç¤ºç¯„ç‰ˆåªæœ‰ä¸€å€‹å›ºå®šæ¸¯å£è³‡æ–™
            const demoPort = {
                id: 1,
                name: "æ¾å±±ç©ºæ¸¯",
                lat: 25.069722,
                lng: 121.5525,
                level: 100, // ç¤ºç¯„ç‰ˆç­‰ç´š
                difficulty: "S" // ç¤ºç¯„ç”¨é›£åº¦æ¨™è¨˜
            };

            // éŠæˆ²ç‹€æ…‹è®Šæ•¸
            let currentPort = null;
            let selectedPortsQueue = [];
            let currentPortIndex = 0;
            let groupMarkers = {1: null, 2: null, 3: null, 5: null};
            let tempGroupMarker = null;
            let groupDistances = {1: null, 2: null, 3: null, 5: null};
            let groupScores = {1: 0, 2: 0, 3: 0, 5: 0};
            let groupBestGuess = {1: Infinity, 2: Infinity, 3: Infinity, 5: Infinity};
            let answerMarker = null;
            let activeGroup = null;
            let resultDisplayed = false;
            let distanceLines = {1: null, 2: null, 3: null, 5: null};
            let distanceLabels = {1: null, 2: null, 3: null, 5: null};
            let groupInteracted = {1: false, 2: false, 3: false, 5: false}; // è·Ÿè¸ªæ¯çµ„æ˜¯å¦æœ‰äº’å‹•
            
            // åœ°åœ–é‚Šç•Œè¨­ç½® - å°åŒ—åœ°å€
            const MAP_BOUNDS = [
                [25.313127, 121.245190], // åŒ—ç•Œ, è¥¿ç•Œ (è¥¿åŒ—è§’)
                [24.946435, 121.885259]  // å—ç•Œ, æ±ç•Œ (æ±å—è§’)
            ];
            
            // åœ°åœ–ä¸­å¿ƒé» - æ¾å±±æ©Ÿå ´é™„è¿‘
            const FIXED_MAP_CENTER = [25.069722, 121.5525];
            
            // æª¢æŸ¥åœ°åœ–å…ƒç´ æ˜¯å¦å­˜åœ¨
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('æ‰¾ä¸åˆ°åœ°åœ–å…ƒç´ ');
                return;
            }
            
            // åˆå§‹åŒ–åœ°åœ–
            let map = null;
            try {
                map = L.map('map', {
                    center: FIXED_MAP_CENTER,
                    zoom: 13,  // é©åˆæ¾å±±æ©Ÿå ´çš„ç¸®æ”¾ç´šåˆ¥
                    minZoom: 9,
                    maxZoom: 15,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // æ·»åŠ åœ°åœ–åœ–å±¤
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // éš±è—attribution
                setTimeout(function() {
                    const attributionElements = document.querySelectorAll('.leaflet-control-attribution');
                    attributionElements.forEach(el => {
                        el.style.display = 'none';
                    });
                }, 100);
                
                console.log('åœ°åœ–åˆå§‹åŒ–æˆåŠŸ');
                
                // åˆå§‹è¨­ç½®åœ°åœ–åˆ°æŒ‡å®šç¯„åœ
                resetMapView();
            } catch (error) {
                console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                alert('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢ã€‚');
                return;
            }

            // è‡ªå®šç¾©åœ–æ¨™æ¨£å¼
            function createGroupIcon(groupId) {
                return L.divIcon({
                    className: `marker-group${groupId}`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
            }

            const answerIcon = L.divIcon({
                className: 'answer-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // é‡ç½®åœ°åœ–è¦–åœ–åˆ°é å®šç¯„åœ
            function resetMapView() {
                map.stop();
                
                // ä»¥æ¾å±±æ©Ÿå ´ç‚ºä¸­å¿ƒ
                map.setView(FIXED_MAP_CENTER, 13, {
                    animate: false
                });
                
                console.log(`ç•¶å‰ç¸®æ”¾ç´šåˆ¥: ${map.getZoom()}`);
            }
            
            // æ›´æ–°æ´»å‹•çµ„åˆ¥é¡¯ç¤º
            function updateActiveGroupDisplay() {
                if (activeGroup) {
                    activeGroupDisplayElement.style.display = 'block';
                    activeGroupDisplayElement.innerHTML = `ç›®å‰ä½œç­”ï¼šç¬¬${activeGroup}çµ„`;
                    activeGroupDisplayElement.style.backgroundColor = getGroupColor(activeGroup);
                    activeGroupDisplayElement.style.color = (activeGroup === 1 || activeGroup === 5) ? 'white' : 'black';
                } else {
                    activeGroupDisplayElement.style.display = 'none';
                }
            }
            
            // è¨ˆæ™‚å™¨ç›¸é—œå‡½æ•¸
            function startTimer() {
                // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
                if (currentTimer) {
                    clearInterval(currentTimer);
                }
                
                // éš±è—è¨ˆæ™‚å™¨è¨­ç½®å€åŸŸ
                timerSettingsElement.style.display = 'none';
                
                // é‡ç½®è¨ˆæ™‚å™¨æ¨£å¼
                timerDisplayElement.classList.remove('timer-warning', 'timer-critical');
                timerDisplayElement.style.backgroundColor = 'rgba(255,255,255,0.9)';
                
                // è¨­ç½®é–‹å§‹æ™‚é–“å’ŒçµæŸæ™‚é–“
                timerStartTime = Date.now();
                timerEndTime = timerStartTime + (timerSeconds * 1000);
                
                // é¡¯ç¤ºåˆå§‹æ™‚é–“
                currentTimerElement.textContent = timerSeconds.toFixed(2);
                timerDisplayElement.style.display = 'block';
                
                // æ›´æ–°æ´»å‹•çµ„åˆ¥é¡¯ç¤º
                updateActiveGroupDisplay();
                
                // é‡ç½®äº’å‹•ç‹€æ…‹
                if (activeGroup) {
                    groupInteracted[activeGroup] = false;
                }
                
                // ç¦ç”¨å…¶ä»–çµ„æŒ‰éˆ•
                disableOtherGroupButtons(activeGroup);
                
                // å•Ÿå‹•è¨ˆæ™‚å™¨ (æ¯10æ¯«ç§’æ›´æ–°ä¸€æ¬¡ä»¥é¡¯ç¤ºå°æ•¸)
                currentTimer = setInterval(function() {
                    const now = Date.now();
                    const timeLeftMs = timerEndTime - now;
                    const timeLeftSec = Math.max(0, timeLeftMs / 1000);
                    
                    // æ›´æ–°é¡¯ç¤ºï¼Œä¿ç•™å…©ä½å°æ•¸
                    currentTimerElement.textContent = timeLeftSec.toFixed(2);
                    
                    // æ›´æ–°è¦–è¦ºæ•ˆæœ
                    if (timeLeftSec <= 10 && timeLeftSec > 5) {
                        timerDisplayElement.classList.add('timer-warning');
                    } else if (timeLeftSec <= 5) {
                        timerDisplayElement.classList.remove('timer-warning');
                        timerDisplayElement.classList.add('timer-critical');
                    }
                    
                    // æ™‚é–“åˆ°
                    if (timeLeftSec <= 0) {
                        clearInterval(currentTimer);
                        handleTimeUp();
                    }
                }, 10);
            }
            
            function stopTimer() {
                if (currentTimer) {
                    clearInterval(currentTimer);
                    currentTimer = null;
                }
                timerDisplayElement.style.display = 'none';
                activeGroupDisplayElement.style.display = 'none';
                
                // å•Ÿç”¨å…¶ä»–çµ„æŒ‰éˆ•
                enableAllGroupButtons();
            }
            
            function handleTimeUp() {
                console.log('æ™‚é–“åˆ°ï¼');
                
                // ç¢ºä¿æœ‰æ´»å‹•çµ„åˆ¥
                if (!activeGroup) return;
                
                // å¦‚æœæœ‰è‡¨æ™‚æ¨™è¨˜ä½†æœªç¢ºèªï¼Œå‰‡è‡ªå‹•ç¢ºèª
                if (tempGroupMarker) {
                    console.log(`è‡ªå‹•ç¢ºèªç¬¬${activeGroup}çµ„æœ€å¾Œé»æ“Šçš„ä½ç½®`);
                    document.getElementById('confirm-guess').click();
                } else if (!groupInteracted[activeGroup]) {
                    // åªæœ‰å®Œå…¨æœªäº’å‹•çš„çµ„åˆ¥æ‰åˆ¤é›¶åˆ†
                    console.log(`ç¬¬${activeGroup}çµ„å®Œå…¨æœªäº’å‹•ï¼Œè¨ˆç‚ºé›¶åˆ†`);
                    
                    // è¨˜éŒ„é›¶åˆ†å’Œç„¡é™é è·é›¢
                    groupDistances[activeGroup] = Infinity;
                    
                    // å°‡è©²çµ„æ·»åŠ åˆ°å·²å®Œæˆæ¨™è¨˜ä¸­ (çœŸæ­£å°‡è©²çµ„æ¨™è¨˜ç‚ºå·²å®Œæˆ)
                    groupMarkers[activeGroup] = 'timeup'; // ç‰¹æ®Šæ¨™è¨˜ï¼Œè¡¨ç¤ºå› è¶…æ™‚ä¸”æœªäº’å‹•è€Œè¢«è¨˜ç‚ºé›¶åˆ†
                    
                    // å¼·åˆ¶æ›´æ–°çµ„æŒ‰éˆ•ç‹€æ…‹ï¼Œç¢ºä¿è¢«æ¨™è¨˜ç‚ºå·²å®Œæˆ
                    const groupBtn = document.querySelector(`button[data-group="${activeGroup}"]`);
                    groupBtn.disabled = true;
                    groupBtn.style.opacity = '0.5';
                    
                    // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰çµ„éƒ½å®Œæˆ
                    checkAllGroupsComplete();
                    
                    // é€šçŸ¥ç”¨æˆ¶è©²çµ„å·²ç¶“å› ç‚ºè¶…æ™‚è€Œè¢«è¨˜ç‚ºé›¶åˆ†
                    setTimeout(() => {
                        alert(`ç¬¬${activeGroup}çµ„æ™‚é–“å·²åˆ°ï¼æœªé€²è¡Œä»»ä½•æ“ä½œï¼Œæœ¬è¼ªè¨˜ç‚º0åˆ†ã€‚`);
                    }, 100);
                } else {
                    // æœ‰äº’å‹•ä½†æ²’æœ‰è‡¨æ™‚æ¨™è¨˜çš„æƒ…æ³
                    console.log(`ç¬¬${activeGroup}çµ„æœ‰äº’å‹•ä½†æ²’æœ‰åšå‡ºé¸æ“‡ï¼Œé‡æ–°é¸æ“‡è©²çµ„`);
                    
                    // ä¸å°‡è©²çµ„æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Œå…è¨±é‡æ–°é¸æ“‡
                    const groupBtn = document.querySelector(`button[data-group="${activeGroup}"]`);
                    groupBtn.style.opacity = '1';
                    groupBtn.disabled = false;
                }
                
                // é‡ç½®æ´»å‹•çµ„åˆ¥
                activeGroup = null;
                updateActiveGroupDisplay();
                
                // åœæ­¢è¨ˆæ™‚å™¨
                stopTimer();
            }
            
            // ç¦ç”¨/å•Ÿç”¨çµ„æŒ‰éˆ•
            function disableOtherGroupButtons(activeGroupId) {
                document.querySelectorAll('button[data-group]').forEach(btn => {
                    const groupId = parseInt(btn.getAttribute('data-group'));
                    if (groupId !== activeGroupId && !groupMarkers[groupId]) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    }
                });
            }
            
            function enableAllGroupButtons() {
                document.querySelectorAll('button[data-group]').forEach(btn => {
                    const groupId = parseInt(btn.getAttribute('data-group'));
                    if (!groupMarkers[groupId]) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                });
            }

            // åˆå§‹åŒ–æ’è¡Œæ¦œ
            function updateLeaderboard() {
                console.log('æ›´æ–°æ’è¡Œæ¦œ');
                const scores = [];
                for (let group of [1, 2, 3, 5]) {
                    scores.push({
                        group: group,
                        score: groupScores[group],
                        bestGuess: groupBestGuess[group] === Infinity ? "å°šç„¡è¨˜éŒ„" : groupBestGuess[group].toFixed(1) + " å…¬é‡Œ"
                    });
                }
                scores.sort((a, b) => b.score - a.score);
            }

            // åˆå§‹åŒ–åˆ†çµ„æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('button[data-group]').forEach(button => {
                button.addEventListener('click', function() {
                    if (resultDisplayed || !currentPort) return;
                    
                    const groupId = parseInt(this.getAttribute('data-group'));
                    console.log(`é¸æ“‡ç¬¬${groupId}çµ„`);
                    
                    // å¾¹åº•æª¢æŸ¥è©²çµ„æ˜¯å¦å·²å®Œæˆ
                    if (groupMarkers[groupId] || this.disabled || groupDistances[groupId] === Infinity) {
                        console.log(`ç¬¬${groupId}çµ„å·²å®Œæˆæˆ–è¢«ç¦ç”¨ï¼Œä¸å¯å†é¸æ“‡`);
                        // å†æ¬¡ç¢ºä¿ç¦ç”¨ç‹€æ…‹
                        this.disabled = true;
                        this.style.opacity = '0.5';
                        return;
                    }
                    
                    // å¦‚æœæœ‰å…¶ä»–æ´»å‹•çµ„åˆ¥ï¼Œå…ˆçµæŸå®ƒ
                    if (activeGroup && activeGroup !== groupId) {
                        stopTimer();
                        document.querySelectorAll('button[data-group]').forEach(btn => {
                            const btnGroupId = parseInt(btn.getAttribute('data-group'));
                            // åªé‚„åŸæœªå®Œæˆçš„çµ„åˆ¥
                            if (!groupMarkers[btnGroupId] && !btn.disabled && groupDistances[btnGroupId] !== Infinity) {
                                btn.style.opacity = '1';
                            } else {
                                // ç¢ºä¿å·²å®Œæˆçš„çµ„åˆ¥æŒ‰éˆ•é¡¯ç¤ºç‚ºç¦ç”¨
                                btn.disabled = true;
                                btn.style.opacity = '0.5';
                            }
                        });
                    }
                    
                    // è¨­å®šç•¶å‰æŒ‰éˆ•ç‚ºactive
                    this.style.opacity = '0.7';
                    activeGroup = groupId;
                    
                    // å•Ÿç”¨ç¢ºèªæŒ‰éˆ•ï¼Œä½†è‹¥æ²’æœ‰è‡¨æ™‚æ¨™è¨˜å‰‡ç¦ç”¨
                    document.getElementById('confirm-guess').disabled = tempGroupMarker ? false : true;
                    
                    // å•Ÿå‹•è¨ˆæ™‚å™¨
                    startTimer();
                });
            });

            // ç¢ºèªçŒœæ¸¬æŒ‰éˆ•
            document.getElementById('confirm-guess').addEventListener('click', function() {
                if (!activeGroup || !tempGroupMarker) return;
                
                console.log(`ç¢ºèªç¬¬${activeGroup}çµ„çš„çŒœæ¸¬`);
                
                // å°‡è‡¨æ™‚æ¨™è¨˜è¨­ç‚ºæ­£å¼æ¨™è¨˜
                groupMarkers[activeGroup] = L.marker(tempGroupMarker.getLatLng(), {
                    icon: createGroupIcon(activeGroup)
                }).addTo(map);
                
                // ç§»é™¤è‡¨æ™‚æ¨™è¨˜
                if (tempGroupMarker) {
                    map.removeLayer(tempGroupMarker);
                    tempGroupMarker = null;
                }
                
                // è¨ˆç®—èˆ‡å¯¦éš›ä½ç½®çš„è·é›¢ï¼ˆæ­¤æ™‚é‚„æœªé¡¯ç¤ºç­”æ¡ˆï¼Œä½†å¯ä»¥å…ˆè¨ˆç®—ï¼‰
                const distance = calculateDistance(
                    groupMarkers[activeGroup].getLatLng().lat,
                    groupMarkers[activeGroup].getLatLng().lng,
                    currentPort.lat,
                    currentPort.lng
                );
                
                groupDistances[activeGroup] = distance;
                
                // ç¦ç”¨è©²çµ„æŒ‰éˆ•ï¼Œé˜²æ­¢å†æ¬¡é¸æ“‡
                document.querySelector(`button[data-group="${activeGroup}"]`).style.opacity = '0.5';
                document.querySelector(`button[data-group="${activeGroup}"]`).disabled = true;
                
                // é‡ç½®æ´»å‹•çµ„åˆ¥
                activeGroup = null;
                updateActiveGroupDisplay();
                
                // ç¦ç”¨ç¢ºèªæŒ‰éˆ•
                document.getElementById('confirm-guess').disabled = true;
                
                // åœæ­¢è¨ˆæ™‚å™¨
                stopTimer();
                
                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰çµ„éƒ½å®ŒæˆçŒœæ¸¬
                checkAllGroupsComplete();
            });

            // åœ°åœ–é»æ“Šäº‹ä»¶ - æ”¾ç½®æš«æ™‚çŒœæ¸¬æ¨™è¨˜
            map.on('click', function(e) {
                if (!activeGroup || resultDisplayed || !currentPort) return;
                
                // æª¢æŸ¥è©²çµ„æ˜¯å¦å·²å®Œæˆ
                if (groupMarkers[activeGroup]) return;
                
                console.log(`åœ°åœ–é»æ“Š - ç¬¬${activeGroup}çµ„ï¼Œä½ç½®: ${e.latlng.lat}, ${e.latlng.lng}`);
                
                // è¨˜éŒ„è©²çµ„å·²æœ‰äº’å‹•
                groupInteracted[activeGroup] = true;
                
                // ç§»é™¤ä¹‹å‰çš„è‡¨æ™‚æ¨™è¨˜
                if (tempGroupMarker) {
                    map.removeLayer(tempGroupMarker);
                }
                
                // æ–°å¢è‡¨æ™‚æ¨™è¨˜
                tempGroupMarker = L.marker(e.latlng, {
                    icon: createGroupIcon(activeGroup),
                    opacity: 0.6
                }).addTo(map);
                
                // å•Ÿç”¨ç¢ºèªæŒ‰éˆ•
                document.getElementById('confirm-guess').disabled = false;
            });

            // åœ°åœ–ç§»å‹•/ç¸®æ”¾äº‹ä»¶ - è¨˜éŒ„äº’å‹•
            map.on('move', function() {
                if (activeGroup) {
                    groupInteracted[activeGroup] = true;
                }
            });
            
            map.on('zoom', function() {
                if (activeGroup) {
                    groupInteracted[activeGroup] = true;
                }
            });

            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰çµ„éƒ½å®ŒæˆçŒœæ¸¬
            function checkAllGroupsComplete() {
                let allComplete = true;
                let anyComplete = false;
                
                // è¨˜éŒ„æ¯çµ„çš„å®Œæˆç‹€æ…‹
                const groupCompletionStatus = {};
                
                for (let group of [1, 2, 3, 5]) {
                    // æª¢æŸ¥å°çµ„æ˜¯å¦å®Œæˆï¼šæœ‰æ­£å¸¸æ¨™è¨˜ã€timeupæ¨™è¨˜ï¼Œæˆ–æŒ‰éˆ•è¢«ç¦ç”¨
                    const hasMarker = groupMarkers[group] !== null && groupMarkers[group] !== undefined;
                    const isTimeup = groupMarkers[group] === 'timeup';
                    const isButtonDisabled = document.querySelector(`button[data-group="${group}"]`).disabled;
                    const hasInfinityDistance = groupDistances[group] === Infinity;
                    
                    // çµ„å®Œæˆçš„æ¢ä»¶ï¼šæœ‰å¯¦éš›æ¨™è¨˜ æˆ– æ¨™è¨˜ç‚ºtimeup æˆ– (æŒ‰éˆ•è¢«ç¦ç”¨ä¸”è·é›¢ç‚ºç„¡é™)
                    const groupCompleted = hasMarker || isButtonDisabled && hasInfinityDistance;
                    
                    // è¨˜éŒ„ç‹€æ…‹ç”¨æ–¼èª¿è©¦
                    groupCompletionStatus[group] = {
                        completed: groupCompleted,
                        hasMarker,
                        isTimeup,
                        isButtonDisabled,
                        hasInfinityDistance
                    };
                    
                    if (!groupCompleted) {
                        allComplete = false;
                    } else {
                        anyComplete = true;
                    }
                    
                    // ç¢ºä¿æŒ‰éˆ•ç‹€æ…‹èˆ‡æ¨™è¨˜ä¸€è‡´
                    if (groupMarkers[group]) {
                        const btn = document.querySelector(`button[data-group="${group}"]`);
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    }
                }
                
                // è©³ç´°è¨˜éŒ„çµ„å®Œæˆç‹€æ…‹
                console.log('çµ„å®Œæˆç‹€æ…‹:', JSON.stringify(groupCompletionStatus, null, 2));
                console.log('æ‰€æœ‰çµ„éƒ½å®Œæˆ:', allComplete, 'ä»»ä¸€çµ„å®Œæˆ:', anyComplete);
                
                // å…¬å¸ƒç­”æ¡ˆæŒ‰éˆ•åƒ…åœ¨æ‰€æœ‰çµ„å®Œæˆæ™‚æ‰å•Ÿç”¨ï¼Œä¸”çµæœå°šæœªé¡¯ç¤º
                document.getElementById('show-answer-btn').disabled = !allComplete || resultDisplayed;
                
                // å¦‚æœçµæœå·²é¡¯ç¤ºä¸”è‡³å°‘æœ‰ä¸€çµ„å®Œæˆï¼Œå•Ÿç”¨å…¬å¸ƒçµæœæŒ‰éˆ•
                if (anyComplete && resultDisplayed) {
                    document.getElementById('show-result-btn').disabled = false;
                }
            }

            // æŠ½æ¸¯å£æŒ‰éˆ• - ç¤ºç¯„ç‰ˆåªæŠ½é¸æ¾å±±ç©ºæ¸¯
            document.getElementById('random-port-btn').addEventListener('click', function() {
                console.log('æŠ½é¸æ¾å±±ç©ºæ¸¯ï¼ˆç¤ºç¯„ç”¨ï¼‰');
                
                // è¨­ç½®ç•¶å‰æ¸¯å£
                currentPort = demoPort;
                
                // æ›´æ–°UIé¡¯ç¤º
                document.getElementById('port-name').innerHTML = `
                <span style="font-family: 'Noto Serif TC', serif; font-weight: 900;">${currentPort.name}</span>
                `;
                document.getElementById('port-level-value').innerHTML = `
                <span style="font-family: 'Almendra', serif; font-weight: 700;">${currentPort.level}</span>
                `;
                
                // ç¦ç”¨æŠ½æ¸¯å£æŒ‰éˆ•
                this.disabled = true;
                
                // éš±è—è¨ˆæ™‚å™¨è¨­ç½®å€åŸŸ
                timerSettingsElement.style.display = 'none';
                
                // é‡ç½®åœ°åœ–è¦–åœ–
                resetMapView();
            });

            // å…¬å¸ƒç­”æ¡ˆæŒ‰éˆ•
            document.getElementById('show-answer-btn').addEventListener('click', function() {
                // å†æ¬¡æª¢æŸ¥æ˜¯å¦æ‰€æœ‰çµ„éƒ½å·²å®Œæˆ
                let allComplete = true;
                for (let group of [1, 2, 3, 5]) {
                    // å¼·åŒ–æª¢æŸ¥ï¼šçµ„å¿…é ˆæœ‰æ¨™è¨˜æˆ–è¢«ç¦ç”¨ä¸”è·é›¢ç‚ºç„¡é™
                    const hasCompleted = groupMarkers[group] !== null || 
                                        (document.querySelector(`button[data-group="${group}"]`).disabled && 
                                         groupDistances[group] === Infinity);
                    if (!hasCompleted) {
                        allComplete = false;
                        break;
                    }
                }
                
                if (allComplete) {
                    showAnswer();
                } else {
                    alert('å°šæœ‰çµ„åˆ¥æœªå®Œæˆä½œç­”ï¼è«‹ç­‰å¾…æ‰€æœ‰çµ„åˆ¥å®Œæˆã€‚');
                    // é‡æ–°ç¦ç”¨æŒ‰éˆ•ï¼Œä»¥é˜²è¬ä¸€
                    this.disabled = true;
                }
            });

            // ä¸‹ä¸€å€‹æ¸¯å£æŒ‰éˆ• - ç¤ºç¯„ç‰ˆåªæœ‰ä¸€è¼ªï¼Œé»æ“Šåé¡¯ç¤ºå®Œæˆç¤ºç¯„
            document.getElementById('next-port-btn').addEventListener('click', function() {
                console.log('ç¤ºç¯„å®Œæˆï¼Œé¡¯ç¤ºå®Œæˆæ¨¡æ…‹çª—å£');
                
                // é¡¯ç¤ºå®Œæˆç¤ºç¯„æ¨¡æ…‹çª—å£
                document.getElementById('demo-complete-modal').style.display = 'flex';
            });
            
            // é–‹å§‹æ­£å¼éŠæˆ²æŒ‰éˆ•
            document.getElementById('start-game-btn').addEventListener('click', function() {
                // è·³è½‰åˆ°æ­£å¼éŠæˆ²é é¢
                window.location.href = 'https://choliage.github.io/TaiwanHarborProject.github.io/main.html';
            });
            
            // é¡¯ç¤ºçµæœæŒ‰éˆ•
            document.getElementById('show-result-btn').addEventListener('click', function() {
                console.log('é¡¯ç¤ºæœ¬è¼ªçµæœæŒ‰éˆ•é»æ“Š');
                showResultModal('round');
            });

            // çµæœæ¨¡æ…‹è¦–çª—é—œé–‰æŒ‰éˆ•
            document.getElementById('modal-close').addEventListener('click', function() {
                document.getElementById('results-modal').style.display = 'none';
            });
            
            // æœ€çµ‚çµæœæ¨¡æ…‹è¦–çª—é—œé–‰æŒ‰éˆ•
            document.getElementById('final-modal-close').addEventListener('click', function() {
                document.getElementById('final-results-modal').style.display = 'none';
            });
            
            // é»æ“Šæ¨¡æ…‹èƒŒæ™¯é—œé–‰æ¨¡æ…‹è¦–çª—
            document.getElementById('results-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // é»æ“Šæ¨¡æ…‹èƒŒæ™¯é—œé–‰æœ€çµ‚çµæœæ¨¡æ…‹è¦–çª—
            document.getElementById('final-results-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // ä¸‹ä¸€å€‹çµæœæŒ‰éˆ• - åˆ‡æ›åˆ°æœ€çµ‚çµæœè¦–åœ–
            document.getElementById('next-result-btn').addEventListener('click', function() {
                document.getElementById('results-modal').style.display = 'none';
                showResultModal('final');
            });
            
            // ä¸Šä¸€å€‹çµæœæŒ‰éˆ• - åˆ‡æ›åˆ°è¼ªæ¬¡çµæœè¦–åœ–
            document.getElementById('prev-result-btn').addEventListener('click', function() {
                document.getElementById('final-results-modal').style.display = 'none';
                showResultModal('round');
            });
            
            // ä¸Šä¸€å€‹æœ€çµ‚çµæœæŒ‰éˆ• - åˆ‡æ›åˆ°è¼ªæ¬¡çµæœè¦–åœ–
            document.getElementById('prev-final-result-btn').addEventListener('click', function() {
                document.getElementById('final-results-modal').style.display = 'none';
                showResultModal('round');
            });
            
            // é¡¯ç¤ºçµæœæ¨¡æ…‹çª—å£
            function showResultModal(type) {
                if (type === 'round') {
                    document.getElementById('results-modal').style.display = 'flex';
                } else if (type === 'final') {
                    document.getElementById('final-results-modal').style.display = 'flex';
                }
            }

            // é‡ç½®ç•¶å‰æ¸¯å£çš„çŒœæ¸¬
            function resetGuesses() {
                console.log('é‡ç½®çŒœæ¸¬ç‹€æ…‹ - æ¸…é™¤æ‰€æœ‰æ¨™è¨˜å’Œæ¨™ç±¤');
                
                // æ¸…é™¤åœ°åœ–ä¸Šçš„æ‰€æœ‰æ¨™è¨˜å’Œé€£ç·š
                for (let group of [1, 2, 3, 5]) {
                    // ç§»é™¤æ¨™è¨˜
                    if (groupMarkers[group]) {
                        console.log(`ç§»é™¤ç¬¬${group}çµ„æ¨™è¨˜`);
                        if (groupMarkers[group] !== 'timeup') {
                            map.removeLayer(groupMarkers[group]);
                        }
                        groupMarkers[group] = null;
                    }
                    
                    // ç§»é™¤é€£ç·š
                    if (distanceLines[group]) {
                        console.log(`ç§»é™¤ç¬¬${group}çµ„é€£ç·š`);
                        map.removeLayer(distanceLines[group]);
                        distanceLines[group] = null;
                    }
                    
                    // ç§»é™¤è·é›¢æ¨™ç±¤
                    if (distanceLabels[group]) {
                        console.log(`ç§»é™¤ç¬¬${group}çµ„è·é›¢æ¨™ç±¤`);
                        map.removeLayer(distanceLabels[group]);
                        distanceLabels[group] = null;
                    }
                    
                    groupDistances[group] = null;
                    groupInteracted[group] = false; // é‡ç½®äº’å‹•ç‹€æ…‹
                    
                    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
                    const btn = document.querySelector(`button[data-group="${group}"]`);
                    if (btn) {
                        btn.style.opacity = '1';
                        btn.disabled = false;
                    }
                }
                
                // ç§»é™¤è‡¨æ™‚æ¨™è¨˜
                if (tempGroupMarker) {
                    console.log('ç§»é™¤è‡¨æ™‚æ¨™è¨˜');
                    map.removeLayer(tempGroupMarker);
                    tempGroupMarker = null;
                }
                
                // ç§»é™¤å¯¦éš›ä½ç½®æ¨™è¨˜
                if (answerMarker) {
                    console.log('ç§»é™¤ç­”æ¡ˆæ¨™è¨˜');
                    map.removeLayer(answerMarker);
                    answerMarker = null;
                }
                
                // é‡ç½®æ´»å‹•çµ„åˆ¥
                activeGroup = null;
                updateActiveGroupDisplay();
                
                // ç¦ç”¨ç¢ºèªæŒ‰éˆ•
                document.getElementById('confirm-guess').disabled = true;
                
                // åœæ­¢è¨ˆæ™‚å™¨
                stopTimer();
                
                // é¡å¤–ç¢ºèªï¼šæƒæåœ°åœ–ä¸Šæ‰€æœ‰æ¨™è¨˜
                map.eachLayer(function(layer) {
                    // æª¢æŸ¥æ˜¯å¦æ˜¯æ¨™è¨˜æˆ–é€£ç·šï¼ˆä¸ç§»é™¤åº•åœ–ï¼‰
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        // æ’é™¤åŸºç¤åœ°åœ–åœ–å±¤
                        if (layer._url === undefined) {
                            console.log('æ¸…é™¤é¡å¤–ç™¼ç¾çš„åœ–å±¤');
                            map.removeLayer(layer);
                        }
                    }
                });
            }

            // é¡¯ç¤ºç­”æ¡ˆ
            function showAnswer() {
                if (!currentPort) return;
                
                console.log('é¡¯ç¤ºç­”æ¡ˆ');
                resultDisplayed = true;
                
                // æ·»åŠ å¯¦éš›ä½ç½®æ¨™è¨˜
                answerMarker = L.marker([currentPort.lat, currentPort.lng], {
                    icon: answerIcon
                }).addTo(map).bindPopup(`<b>${currentPort.name}</b><br>ç­‰ç´š: ${currentPort.level}`);
                
                // æ·»åŠ é€£ç·šå’Œä½ç½®ä¿¡æ¯
                for (let group of [1, 2, 3, 5]) {
                    // é‡å°å¯¦éš›æ”¾ç½®äº†åœ°åœ–æ¨™è¨˜çš„çµ„åˆ¥
                    if (groupMarkers[group] && groupMarkers[group] !== 'timeup') {
                        // æ·»åŠ è™›ç·šé€£æ¥
                        const markerPos = groupMarkers[group].getLatLng();
                        const answerPos = [currentPort.lat, currentPort.lng];
                        
                        console.log(`å‰µå»ºç¬¬${group}çµ„é€£ç·š`);
                        
                        // å‰µå»ºè™›ç·š - ä½¿ç”¨å„çµ„çš„é¡è‰²
                        distanceLines[group] = L.polyline([markerPos, answerPos], {
                            color: getGroupColor(group),
                            dashArray: '5, 10',
                            weight: 3,
                            opacity: 0.9
                        }).addTo(map);
                        
                        // è¨ˆç®—è·é›¢
                        groupDistances[group] = calculateDistance(
                            markerPos.lat,
                            markerPos.lng,
                            currentPort.lat,
                            currentPort.lng
                        );
                        
                        console.log(`ç¬¬${group}çµ„è·é›¢: ${groupDistances[group].toFixed(1)} å…¬é‡Œ`);
                        
                        // ç‚ºæ¨™è¨˜æ·»åŠ é»æ“Šäº‹ä»¶å’Œå½ˆå‡ºçª—å£ï¼Œè€Œä¸æ˜¯å›ºå®šæ¨™ç±¤
                        groupMarkers[group].bindPopup(
                            `<div style="font-family: 'Noto Serif TC', sans-serif !important; font-weight: bold; font-size: 16px; text-align: center;">
                                ç¬¬${group}çµ„ï¼š${groupDistances[group].toFixed(1)}å…¬é‡Œ
                            </div>`,
                            {
                                className: 'custom-popup',
                                closeButton: false
                            }
                        );
                        
                        // æ·»åŠ æ‡¸åœäº‹ä»¶
                        groupMarkers[group].on('mouseover', function() {
                            this.openPopup();
                        });
                        
                        // å„²å­˜è·é›¢è¨˜éŒ„ï¼ˆä¸å†å‰µå»ºæ¨™ç±¤ï¼‰
                        distanceLabels[group] = null;
                    } else if (groupMarkers[group] === 'timeup' || groupDistances[group] === Infinity) {
                        // å°æ–¼å› è¶…æ™‚è€Œè¢«è¨˜ç‚ºé›¶åˆ†æˆ–æœªé¸æ“‡ä½ç½®çš„çµ„åˆ¥
                        console.log(`ç¬¬${group}çµ„æœªé¸æ“‡ä½ç½®æˆ–è¶…æ™‚ï¼Œè·é›¢è¨­ç‚ºInfinity`);
                        groupDistances[group] = Infinity;
                        
                        // ç¢ºä¿è©²çµ„æŒ‰éˆ•è¢«ç¦ç”¨
                        const btn = document.querySelector(`button[data-group="${group}"]`);
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    }
                }
                
                // èª¿æ•´åœ°åœ–è¦–åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜
                const bounds = [];
                bounds.push([currentPort.lat, currentPort.lng]);
                
                for (let group of [1, 2, 3, 5]) {
                    if (groupMarkers[group] && groupMarkers[group] !== 'timeup') {
                        // æ·»åŠ æ¨™è¨˜ä½ç½®
                        bounds.push([groupMarkers[group].getLatLng().lat, groupMarkers[group].getLatLng().lng]);
                    }
                }
                
                // å¦‚æœæœ‰æ¨™è¨˜å’Œé€£ç·šï¼Œä½¿ç”¨å®ƒå€‘çš„é‚Šç•Œ
                if (bounds.length > 1) {
                    console.log('èª¿æ•´åœ°åœ–è¦–åœ–ç¯„åœ');
                    // è¨ˆç®—æ¨™è¨˜çš„é‚Šç•Œ
                    const markerBounds = L.latLngBounds(bounds);
                    
                    // æª¢æŸ¥é‚Šç•Œæ˜¯å¦åœ¨åœ°åœ–ç¯„åœå…§
                    if (markerBounds.isValid()) {
                        // æ“´å±•é‚Šç•Œï¼Œç¢ºä¿æœ‰é©ç•¶çš„ç©ºé–“
                        const paddedBounds = markerBounds.pad(0.15);
                        
                        // æ‡‰ç”¨é‚Šç•Œï¼Œä½¿ç”¨åˆé©çš„å…§é‚Šè·
                        map.fitBounds(paddedBounds, { 
                            padding: [50, 50],
                            maxZoom: 12,
                            animate: true
                        });
                    } else {
                        // å¦‚æœè¨ˆç®—å‡ºçš„é‚Šç•Œç„¡æ•ˆï¼Œå‰‡ä½¿ç”¨é»˜èªè¦–åœ–
                        resetMapView();
                    }
                } else {
                    // æ²’æœ‰è¶³å¤ çš„é»ä¾†è¨ˆç®—é‚Šç•Œ
                    resetMapView();
                }
                
                // è¨ˆç®—åˆ†æ•¸ä¸¦å¡«å……çµæœ
                let results = [];
                for (let group of [1, 2, 3, 5]) {
                    if (groupDistances[group] !== null) {
                        const distance = groupDistances[group];
                        
                        // GeoGuessré¢¨æ ¼çš„è¨ˆåˆ† (5000åˆ†åˆ¶)
                        let score = 0;
                        if (distance === Infinity) {
                            // ç„¡é™é è·é›¢ä»£è¡¨æœªé¸æ“‡ä½ç½®æˆ–è·³éï¼Œçµ¦äºˆé›¶åˆ†
                            score = 0;
                        } else if (distance < 0.1) {
                            score = 5000;
                        } else if (distance < 1) {
                            score = 5000 - (distance * 1000);
                        } else if (distance < 5) {
                            score = 4000 - (distance * 200);
                        } else if (distance < 10) {
                            score = 3000 - (distance * 100);
                        } else if (distance < 20) {
                            score = 2000 - (distance * 50);
                        } else {
                            score = Math.max(0, 1000 - (distance * 20));
                        }
                        score = Math.round(score);
                        
                        // æ›´æ–°è©²çµ„çš„ç¸½åˆ†
                        groupScores[group] += score;
                        
                        // æ›´æ–°è©²çµ„çš„æœ€ä½³çŒœæ¸¬è¨˜éŒ„
                        if (distance !== Infinity && distance < groupBestGuess[group]) {
                            groupBestGuess[group] = distance;
                        }
                        
                        // æ·»åŠ åˆ°çµæœæ•¸çµ„
                        results.push({
                            group: group,
                            distance: distance,
                            score: score
                        });
                    }
                }
                
                // æŒ‰è·é›¢æ’åºï¼Œç„¡é™é çš„æ”¾åœ¨æœ€å¾Œ
                results.sort((a, b) => {
                    if (a.distance === Infinity) return 1;
                    if (b.distance === Infinity) return -1;
                    return a.distance - b.distance;
                });
                
                // æ›´æ–°æ’è¡Œæ¦œ
                updateLeaderboard();
                
                // æº–å‚™çµæœå½ˆçª—æ•¸æ“š
                prepareResultsModal(results);
                prepareFinaLResultsModal(results);
                
                // å•Ÿç”¨é¡¯ç¤ºçµæœæŒ‰éˆ•
                document.getElementById('show-result-btn').disabled = false;
                
                // å•Ÿç”¨ä¸‹ä¸€è¼ªæŒ‰éˆ•ï¼ˆç¤ºç¯„ç‰ˆåªæœ‰ä¸€è¼ªï¼Œé»æ“Šåé¡¯ç¤ºå®Œæˆç¤ºç¯„ï¼‰
                document.getElementById('next-port-btn').disabled = false;
                
                // ç¢ºä¿çµæœå’Œä¸‹ä¸€è¼ªæŒ‰éˆ•å¯é»æ“Š
                console.log('ç¢ºä¿æŒ‰éˆ•å¯é»æ“Š');
                setTimeout(() => {
                    const nextBtn = document.getElementById('next-port-btn');
                    const resultBtn = document.getElementById('show-result-btn');
                    
                    nextBtn.disabled = false;
                    console.log('å·²å•Ÿç”¨ä¸‹ä¸€è¼ªæŒ‰éˆ•');
                    
                    resultBtn.disabled = false;
                    console.log('å·²å•Ÿç”¨å±•ç¤ºçµæœæŒ‰éˆ•');
                }, 500);
            }
            
            // æº–å‚™çµæœæ¨¡æ…‹è¦–çª—æ•¸æ“š
            function prepareResultsModal(results) {
                console.log('æº–å‚™çµæœæ¨¡æ…‹è¦–çª—æ•¸æ“š');
                
                // è¨­ç½®è¼ªæ¬¡æ¨™é¡Œ
                document.getElementById('round-title').textContent = `ç¤ºç¯„è¼ª`;
                
                // è¨­ç½®æ¸¯å£åç¨±
                document.getElementById('port-result-name').textContent = currentPort.name;
                
                // è¨­ç½®ç²å‹è€…è³‡è¨Š
                const validResults = results.filter(r => r.distance !== Infinity);
                if (validResults.length > 0) {
                    const winner = validResults[0]; // è·é›¢æœ€çŸ­çš„æ˜¯ç²å‹è€…
                    document.getElementById('winner-title').textContent = `ç¬¬${winner.group}çµ„æœ€æ¥è¿‘${currentPort.name}ï¼`;
                    document.getElementById('winner-info').textContent = 
                        `è·é›¢${winner.distance.toFixed(1)}å…¬é‡Œï¼ç²å¾—${winner.score}åˆ†`;
                } else {
                    document.getElementById('winner-title').textContent = "æœ¬è¼ªç„¡äººç²å‹";
                    document.getElementById('winner-info').textContent = "æ‰€æœ‰å°çµ„å‡æœªå®ŒæˆçŒœæ¸¬";
                }
                
                // æ›´æ–°ç©åˆ†æ¦œ
                const modalLeaderboard = document.getElementById('modal-leaderboard');
                modalLeaderboard.innerHTML = '';
                
                // å°‡åˆ†æ•¸æ’åº
                const scores = [];
                for (let group of [1, 2, 3, 5]) {
                    // æŸ¥æ‰¾æœ¬è¼ªå¾—åˆ†å’Œè·é›¢
                    const result = results.find(r => r.group === group);
                    scores.push({
                        group: group,
                        score: groupScores[group],
                        roundScore: result ? result.score : 0,
                        distance: result ? result.distance : null
                    });
                }
                scores.sort((a, b) => b.score - a.score);
                
                // å¡«å……è¡¨æ ¼
                scores.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ç²å‹çµ„
                    const isWinner = validResults.length > 0 && entry.group === validResults[0].group;
                    if (isWinner) {
                        row.className = 'winner-row';
                        row.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
                    }
                    
                    let distanceText = entry.distance === null ? "æœªé¸æ“‡ä½ç½®" : 
                                      entry.distance === Infinity ? "æœªé¸æ“‡ä½ç½®" : 
                                      entry.distance.toFixed(1) + ' å…¬é‡Œ';
                    
                    row.innerHTML = `
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">${index + 1}</td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">
                            <span class="group-badge" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; background-color: ${getGroupColor(entry.group)};"></span>
                            ${isWinner ? 'ç¬¬' + entry.group + 'çµ„ ğŸ†' : 'ç¬¬' + entry.group + 'çµ„'}
                        </td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">${entry.score}</td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">+${entry.roundScore}</td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">${distanceText}</td>
                    `;
                    modalLeaderboard.appendChild(row);
                });
            }
            
            // æº–å‚™æœ€çµ‚çµæœæ¨¡æ…‹è¦–çª—æ•¸æ“š
            function prepareFinaLResultsModal(results) {
                console.log('æº–å‚™æœ€çµ‚çµæœæ¨¡æ…‹è¦–çª—æ•¸æ“š');
                
                // æ±ºå®šæœ€çµ‚ç²å‹è€…
                const validResults = results.filter(r => r.distance !== Infinity);
                let winner = null;
                if (validResults.length > 0) {
                    winner = validResults[0].group; // ä½¿ç”¨æœ¬è¼ªç¬¬ä¸€åä½œç‚ºç¤ºç¯„ç”¨çš„æœ€çµ‚å† è»
                }
                
                // è¨­ç½®ç²å‹è€…è³‡è¨Š
                if (winner) {
                    document.getElementById('final-winner-title').textContent = `ç¬¬${winner}çµ„ç²å¾—æœ€çµ‚å† è»ï¼`;
                    document.getElementById('final-winner-info').textContent = 
                        `ç¸½ç©åˆ†ï¼š${groupScores[winner]}`;
                } else {
                    document.getElementById('final-winner-title').textContent = "æ²’æœ‰ç²å‹è€…";
                    document.getElementById('final-winner-info').textContent = "ç„¡æ³•ç¢ºå®šç²å‹çµ„åˆ¥";
                }
                
                // æ›´æ–°æœ€çµ‚ç©åˆ†æ¦œ
                const finalLeaderboard = document.getElementById('final-modal-leaderboard');
                finalLeaderboard.innerHTML = '';
                
                // å°‡åˆ†æ•¸æ’åº
                const scores = [];
                for (let group of [1, 2, 3, 5]) {
                    // æŸ¥æ‰¾æœ¬è¼ªå¾—åˆ†å’Œè·é›¢
                    const result = results.find(r => r.group === group);
                    scores.push({
                        group: group,
                        score: groupScores[group], // ç‚ºäº†ç¤ºç¯„ï¼Œä½¿ç”¨ç›¸åŒçš„åˆ†æ•¸
                        roundScore: result ? result.score : 0,
                        distance: result ? result.distance : null
                    });
                }
                scores.sort((a, b) => b.score - a.score);
                
                // å¡«å……è¡¨æ ¼
                scores.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    // æª¢æŸ¥æ˜¯å¦æ˜¯æœ€çµ‚ç²å‹çµ„
                    const isWinner = entry.group === winner;
                    if (isWinner) {
                        row.className = 'winner-row';
                        row.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
                    }
                    
                    let distanceText = entry.distance === null ? "æœªé¸æ“‡ä½ç½®" : 
                                      entry.distance === Infinity ? "æœªé¸æ“‡ä½ç½®" : 
                                      entry.distance.toFixed(1) + ' å…¬é‡Œ';
                    
                    row.innerHTML = `
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">${index + 1}</td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">
                            <span class="group-badge" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; background-color: ${getGroupColor(entry.group)};"></span>
                            ${isWinner ? 'ç¬¬' + entry.group + 'çµ„ ğŸ†' : 'ç¬¬' + entry.group + 'çµ„'}
                        </td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">${entry.score}</td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">+${entry.roundScore}</td>
                        <td style="font-family: 'Noto Serif TC', sans-serif !important; padding: 8px 5px; border-bottom: 1px solid #eee;">${distanceText}</td>
                    `;
                    finalLeaderboard.appendChild(row);
                });
            }

            // å–å¾—çµ„åˆ¥å°æ‡‰çš„é¡è‰²
            function getGroupColor(groupId) {
                const colors = {
                    1: '#DA6B6B',
                    2: '#DABF6B',
                    3: '#9CB68A',
                    5: '#7D98B1'
                };
                return colors[groupId] || '#95a5a6';
            }

            // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢ï¼ˆå…¬é‡Œï¼‰
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
                const dLat = deg2rad(lat2 - lat1);
                const dLon = deg2rad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2); 
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                const distance = R * c;
                return distance;
            }

            function deg2rad(deg) {
                return deg * (Math.PI/180);
            }
            
            console.log('éŠæˆ²åˆå§‹åŒ–å®Œæˆ');
        }
    </script>
</body>
</html>